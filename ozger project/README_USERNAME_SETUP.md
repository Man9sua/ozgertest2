# Настройка Username функциональности

## Проблема
Ранее username сохранялся только в user_metadata Supabase Auth, но не сохранялись поля class_digit и class_symbol, и не было возможности входа по username.

## Решение
Добавлена поддержка сохранения username в таблицу `auth_audit` и полного профиля в таблицу `profiles`.

## Настройка базы данных

1. **Выполните SQL скрипт** `supabase_setup.sql` в Supabase SQL Editor
2. **Проверьте таблицы**:
   - `auth_audit` - для соответствия username ↔ email
   - `profiles` - для полного профиля пользователя

## Изменения в коде

### Новые функции:
- `saveUsernameToAudit(username, email)` - сохраняет username в auth_audit
- `saveUserProfileToDatabase(profileData)` - сохраняет полный профиль в profiles
- `getEmailByUsername(username)` - получает email по username
- `loadUserProfileFromDatabase()` - загружает профиль из базы данных
- `loadUsernameForLogin()` - загружает username в форму входа

### Изменения в регистрации:
- Username сохраняется сразу после регистрации (даже если требуется подтверждение email)
- Полный профиль сохраняется в таблицу profiles
- Fallback логика для случаев, когда auth_audit недоступна

### Изменения во входе:
- Поддержка входа по username или email
- Автоматическая загрузка username в форму входа
- Загрузка полного профиля из базы данных

## Тестирование

1. **Регистрация**: Создайте нового пользователя - username должен сохраниться
2. **Вход по username**: Попробуйте войти используя username вместо email
3. **Вход по email**: Должен работать как раньше
4. **Проверка профиля**: После входа проверьте, что все поля загружены (включая class_digit и class_symbol)

## Возможные проблемы

1. **Таблица не существует**: Выполните `supabase_setup.sql`
2. **Права доступа**: Проверьте RLS политики в Supabase
3. **Email confirmation**: Если включено подтверждение email, некоторые данные могут сохраняться только после подтверждения

## Логи
Все операции логируются в консоль браузера для отладки.
